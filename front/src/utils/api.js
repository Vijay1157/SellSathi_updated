import { auth } from '../config/firebase';

export const API_BASE = 'http://localhost:5000';

/**
 * Authenticated fetch wrapper.
 *
 * PRIORITY ORDER:
 * 1. If the stored user is a test-login user (uid starts with "test_"):
 *    → Always send X-Test-UID. Ignore Firebase Auth entirely.
 *      This prevents stale Firebase sessions from sending expired Bearer tokens
 *      when the actual logged-in user is a test credential user.
 *
 * 2. If a real Firebase Auth session exists (auth.currentUser):
 *    → Force-refresh the ID token (prevents 401 from expired tokens)
 *    → Send Authorization: Bearer <token>
 *    → If refresh fails, fall back to X-Test-UID from localStorage
 *
 * 3. No Firebase session, non-test user in localStorage:
 *    → Send X-Test-UID from localStorage uid
 *
 * @param {string} path - API path (e.g. '/admin/stats')
 * @param {object} options - Standard fetch options (method, body, etc.)
 * @returns {Promise<Response>}
 */
export async function authFetch(path, options = {}) {
    const url = `${API_BASE}${path}`;
    const headers = { ...options.headers };
    if (!(options.body instanceof FormData) && !headers['Content-Type']) {
        headers['Content-Type'] = 'application/json';
    }

    // Read stored user from localStorage
    let localUser = null;
    try {
        localUser = JSON.parse(localStorage.getItem('user'));
    } catch (_) { /* ignore parse errors */ }

    // ── PATH 1: Test-login user ───────────────────────────────────────────────
    // UIDs generated by /auth/test-login always start with "test_".
    // If that's what's stored, always send X-Test-UID — never a Firebase token.
    // This prevents a stale Firebase Auth session from hijacking test-user requests.
    if (localUser?.uid?.startsWith('test_')) {
        headers['X-Test-UID'] = localUser.uid;
        return fetch(url, { ...options, headers });
    }

    // ── PATH 2: Real Firebase Auth session ────────────────────────────────────
    const currentUser = auth.currentUser;
    if (currentUser) {
        try {
            // Force-refresh the token to prevent 401 from expired tokens
            const idToken = await currentUser.getIdToken(true);
            headers['Authorization'] = `Bearer ${idToken}`;
        } catch (err) {
            console.warn('[authFetch] Token refresh failed, falling back to X-Test-UID:', err.message);
            // Firebase session is broken — fall back to stored UID
            if (localUser?.uid) {
                headers['X-Test-UID'] = localUser.uid;
            }
        }
        return fetch(url, { ...options, headers });
    }

    // ── PATH 3: No Firebase session — use stored UID ──────────────────────────
    if (localUser?.uid) {
        headers['X-Test-UID'] = localUser.uid;
    }

    return fetch(url, { ...options, headers });
}
